# -----------------------------------------------------------------------------
# DSXâ€‘Connect Helm values (production defaults)
# - External DSXA is assumed (dsxa-scanner.enabled=false)
# - REQUIRED: set global.env.DSXCONNECT_SCANNER__SCAN_BINARY_URL to your DSXA URL
# - API/workers LOG_LEVEL default to 'info'
# - Override image tag at install time: --set-string global.image.tag=<version>
# -----------------------------------------------------------------------------
# Global settings used by all dsx-connect components
global:
  # Minimal, common env most users need to touch. Everything else is set in templates with sane defaults.
  env:
    # REQUIRED when (dsxa-scanner.enabled=false): set to your external DSXA endpoint
    DSXCONNECT_SCANNER__SCAN_BINARY_URL: "http://external-dsxa:5000/scan/binary/v2"
    # Optional: auth token for DSXA (sent as AUTH/AUTH_TOKEN headers by dsxa_sdk)
    # DSXCONNECT_SCANNER__AUTH_TOKEN: ""

    DSXCONNECT_SYSLOG__SYSLOG_SERVER_URL: "rsyslog"
    DSXCONNECT_SYSLOG__SYSLOG_SERVER_PORT: "514"
    DSXCONNECT_SYSLOG__TRANSPORT: "tcp"
    # DIANNA malicious SIEM index retention (separate from scan_results retention)
    DSXCONNECT_DIANNA__ENABLED: "true"
    DSXCONNECT_DIANNA__INDEX_DATABASE_LOC: "redis://redis:6379/4"
    DSXCONNECT_DIANNA__INDEX_RETAIN_DAYS: "90"
    DSXCONNECT_DIANNA__INDEX_STORE_ON_MALICIOUS: "true"

  # Optional shared image defaults (components fall back to these when set)
  image:
    repository: dsxconnect/dsx-connect
    tag: ""
    pullPolicy: IfNotPresent
    # Note: When installing from an OCI chart with --version=X.Y.Z, the default image tag will be that chart's appVersion.

  # Optional scanner service hints used when the dsxa-scanner dependency is enabled
  scanner:
    # serviceName: "dsxa-scanner"   # optional: explicit K8s service name (defaults to <release>-dsxa-scanner)
    # port: 5000                     # optional: override port (defaults to 5000)
    # scheme: http                   # optional: http|https (defaults to http)

# typical deployments would have dsxa-scanners in their own cluster and/or namespace, but if all that's needed
# is a single dsxa-scanner pod that only supports scan/binary/v2 (file size <= 2GB), then enable here.
dsxa-scanner:
  enabled: false
#  env:
#    # Override these with your own DSXA appliance settings before enabling in any environment.
#    APPLIANCE_URL: "your-dsxa-appliance.deepinstinctweb.com"
#    TOKEN: "REPLACE_WITH_APPLIANCE_TOKEN"
#    SCANNER_ID: "0"
#    FLAVOR: "rest,config"
#    NO_SSL: "true"
#    AUTH_TOKEN: ""

dsx-connect-api:
  enabled: true
  service:
    port: 80
    # type: ClusterIP
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  tls:
    enabled: false
    # secretName: ""           # defaults to <release>-dsx-connect-api-tls when enabled
  env:
    LOG_LEVEL: info
  auth:
    enabled: true
    # Example enrollment Secret in examples/secrets/auth-enrollment-secret.yaml.
    # Secret name defaults to <release>-dsx-connect-api-auth-enrollment when enabled
    # Leave value unset in production so the chart references your Secret instead.
    enrollment:
      key: ENROLLMENT_TOKEN

dsx-connect-scan-request-worker:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi
  env:
    LOG_LEVEL: info
  celery:
    # queue: "dev.dsx_connect.scans.request"
    concurrency: 2

dsx-connect-scan-request-batch-worker:
  enabled: false
  replicaCount: 1
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env:
    LOG_LEVEL: info
  celery:
    # queue: "dev.dsx_connect.scans.request.batch"
    concurrency: 1
    batchSize: 10
    maxBatchSize: 100

dsx-connect-verdict-action-worker:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env:
    LOG_LEVEL: info
  celery:
    # queue: "dev.dsx_connect.scans.verdict"
    concurrency: 1

dsx-connect-results-worker:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env:
    LOG_LEVEL: info
    DSXCONNECT_SYSLOG__TRANSPORT: tcp
  celery:
    # queue: "dev.dsx_connect.scans.result"
    concurrency: 1

dsx-connect-notification-worker:
  enabled: true
  replicaCount: 1
  # image:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi
  env:
    LOG_LEVEL: info
  celery:
    # queue: "dev.dsx_connect.scans.result.notify"
    concurrency: 1

dsx-connect-dianna-worker:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env:
    LOG_LEVEL: info
  celery:
    # queue: "dev.dsx_connect.analyze.dianna"
    concurrency: 1
  dianna:
    # Override other DIANNA tuning (verifyTls, chunkSize, poll settings, etc.) here if needed.
    # verifyTls: true
    # caBundle: ""
    # chunkSize: 4194304
    # timeout: 60
    # autoOnMalicious: false
    # pollResultsEnabled: true
    # pollIntervalSeconds: 5
    # pollTimeoutSeconds: 900

redis:
  enabled: true
  fullnameOverride: redis
  image:
    repository: redis
    tag: "7-alpine"
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 2Gi
  # For advanced tuning (command flags, probes, resources), see charts/redis/values.yaml.

rsyslog:
  enabled: true
  fullnameOverride: rsyslog
  # The bundled rsyslog chart forwards scan results to external syslog collectors. If you enable TLS forwarding,
  # rsyslog must have the gtls module available. The stock rsyslog/rsyslog image does not ship with gtls, so you
  # need to use a small derivative image.
  image:
    repository: dsxconnect/dsx-connect-rsyslog-gnutls
    tag: "1.0.3"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi
  # For advanced tuning, see charts/rsyslog/values.yaml.
  # example forwarding:
#  config:
#    forward:
#      enabled: true
#      format: "solarwinds"
#      token: "<solar winds destination token>"
#      target: "syslog.collector.na-01.cloud.solarwinds.com"
#      port: 6514
#      tls: true
#      permittedPeer: "*.collector.na-01.cloud.solarwinds.com"
